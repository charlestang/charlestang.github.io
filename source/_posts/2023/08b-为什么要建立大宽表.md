---
title: 为什么要建立大宽表
tags:
  - Database
categories:
  - [工作相关]
date: 2023-08-07 15:20:00
permalink: 2023/why-we-build-large-wide-table/
---

对于大数据开发的同学来说，在数据仓库中，建立好大宽表，大概是显然的，不言自明的。不过对于一般的后台开发来说，做这样的事情，可能是每个人心中很抗拒的事情。

这就不得不说明一下两个工种的特点。众所周知，数据仓库，一般应用在 OLAP 的场景，属于在线分析，一般开发者自己需要开发很多数据分析的需求，或者满足客户的分析需求。

而后台开发，一般应用场景是 OLTP，顾名思义是在线交易场景。在进行大量的数据库查询和数据库事务的情景下，我们在使用数据的时候，最最担心的往往是一致性问题，如果一份数据，出现在两个地方，我们就总要担心这两份拷贝的一致性问题，如果不一致如何进行同步，中间的延迟是多少。

如果在数据设计的时候，就没有任何冗余，也即所有的数据只有一份，就天然规避了大量的一致性问题的处理。

而在数据分析领域，则不然，首先，我们对数据的延迟，容忍度很高，很多的分析场景都是 T + 1 的时效性，当然越快越好，有些甚至是月报。但是虽然对实时性要求不高，但是分析的复杂性往往非常高。比如，经常需要观测五维甚至六维的数据，如果在一个 OLTP 的数据库上，不但需要 JOIN 非常多的表，而且要针对不同的视角，专门去构建查询。

如果一个统计视角，除了改换维度，再结合一些新的聚合要求，那么对同一份数据的不同统计，往往会差距非常大。

在一个后台开发团队，常见的可能由不同的程序员开发不同维度的统计报表，这时候，两个甚至多个不同开发工程师，输出的报表之间的内在统一性成了最大的问题。比如，我遇到情况就是，老板用一份报表去检查另一份报表。

因为是不同的人，从原始的业务模型中 JOIN 和 GroupBy 出来的数据，极可能就有所差距，再碰上一点点 bug 的话，经常会无从查起，定位极其空难，我曾经甚至做过，将统计 SQL 改为 select 明细，然后导出明细进行两相对账的操作，以确定两种不同的统计，差异值产生的原因。

而宽表，我认为，本质上，是一个高维数据在二维上的展开，这份表从原理上来说，必然会产生冗余，至少，很多状态字段，主从关系，就要做惩罚展开，才能变成二维的宽表。有了这样的宽表后，我们只需要关注后续的聚合即可，两个不同的人开发不同的聚合，但是却不用考虑连表的顺序和条件问题，不会在这个地方产生遗漏或者重复等问题。两张不同视角报表，依赖同一份基础数据，那么其问题的检查和定位是更容易的。

宽表还有一个至关重要的优势，如果宽表管理得当，是很容易在不同的需求中复用的，毕竟它只是一个二维展开，但是仍然保留了很大的可能性。如果一个开发总是可以轻松清晰地获知一份宽表的字段定义和开发目的，那么其在实现自己的统计报表需求时，就可以做到最大限度地调用。

说了很多优点，缺点和难点却不得不提。

比如，一致性和延迟就是一个最大的问题。客户是不会容忍你，多少分钟同步一次的。他们只觉得，我在系统里改了数据，我的统计值为什么不变？解决这个问题，就要做好事先需求的沟通和用户教育，对用户做出延迟承诺，比如，XX数据，在变更后，至多 10 分钟完成各种环境的同步，这就是一种服务承诺。通过这样的方法，在用户心中建立合理的预期。

第二，宽表构建的依赖和调度的复杂度。比如宽表里的字段，有些在构建时期，就是通过多个关系表，关联起来以后综合计算或者说判断的，在宽表里表达很简单，只是一个字段而已，但是计算过程可能就比较麻烦，有着前后依赖。我举个例子，比如我们用的一个金额列，必须先计算当地支付金额，然后在这个基础上，查询货币兑换的比值（需要用币种和两发生时间查表得到），进行外币折算后，才能成为一个有效的金额字段。在进行此类字段的构建时，就出现了依赖的问题，我先要构建第一个字段，然后查询其汇率，才能构建第二个字段。构建时候需要先计算原始币种，发生事件，然后下一步骤才能计算折算金额，有前后依赖问题。

另一个自然想到的问题，是一旦业务数据库发生了变化，这种前后依赖的数据计算，还需要被及时和顺序地调度，这就引发了需要一个强大的依赖管理和任务调度系统。才能有效实现数据宽表的及时更新。

