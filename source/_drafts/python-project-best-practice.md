---
title: 创建 Python 项目的最佳实践
tags:
  - practice
  - python
id: '1057'
categories:
  - [工作相关, Python]
  - [ 小窍门]
date: 2021-05-25 13:08:15
---

学习 Python 有几个月时间了，此前，也间或写过几个 Python 的脚本，都是单个文件，批处理式地命令堆砌，倒是也非常爽快，不过从没有正儿八经做过项目，为了形成对这一块内容的认识，我找一篇《[最佳实践](https://sourcery.ai/blog/python-best-practices/)》来看看，先不管对错，进行一番实践，也好有个感性认识。
<!-- more -->
## pipx

这个是前置的包管理工具，专门用来安装可以当作 Shell 命令使用的软件包，pip 是更通用的工具，可以安装各种 Python 的 package，类库也好，命令行也好。不过，我似乎也嗅到了一些 bad smell，很多文章的观点，畏惧 pip 如虎，似乎其也是一个著名的双刃剑，好用的同时，也很容易引起混乱，导致大家都小心翼翼的。pipx 主打的功能是“**在隔离的环境里安装和运行应用软件**”，也就不难理解了。

```shell
python3 -m pip install --user pipx
python3 -m pipx ensurepath
```

上面的两个命令都带有了防御的性质，其实一般的操作系统（Mac 11.x 或者 Ubuntu 20.04），都是同时带有两个版本的 python 的，如果执行 python 命令，默认调用的是 python 2.x，与之对应的包管理是 pip 命令，执行 python3 命令，调用的是 python 3.x 解释器，与之对应的包管理器命令是 pip3。python3 其实应该是个软链，也是各种系统处理 python 混乱的版本与兼容的常见做法，如果你自己用了 homebrew 之流，会把你系统上的版本搞得更混乱一点，所以上面两个范例命令已经是按照最大兼容来写了。希望能奏效。

--user 参数是一个注意点，我以前其实也不这么安装包，我有很多坏习惯，比如用 root 登录 server，pip install 的时候，我也不会加 --user 参数，估计就是老手群体人人喊打的坏人吧，哈哈。这个 --user 参数的作用是将包安装在用户目录里，意思是不要污染掉整个操作系统，污染你自己的帐号即可，哈哈。

第二个命令，其实就是调整好正确的环境变量，确保 pipx 以及通过其安装的命令，可以直接执行，不用在外面再 wrapper python3 之类的解释器。说起来，pipx 也是确保只污染你自己，不要扰乱整个操作系统的一个工具。

吐槽：警告新手不要使用 sudo pip install，以及不要直接用 pip install 的文章，应该也不难搜到，看来很多人已经深受其害，可能这也是 pipx 出现的原因。对于我这种初学者来说，真的太不友好了，pip，PyPI 之类的包管理就不止一个，各自的坑也没有太多详细资料。甚至在不同系统上，会同时出现 pip，pip3，不同 Python 版本打架也是让新手困扰。这么好的一门语言，被自己的社区搞得乌烟瘴气。

## 环境管理

Python 有很多环境管理工具，我以前用过一点 virtualenv，据说是很好的东西，后来，也接触了 conda，据说是很好的东西，最佳实践又介绍了一种，pipenv，据说也是很好的东西 😂

这些东西，其实也是确保你不要污染别人，只污染你自己，或者只污染你这个项目，或者别人也不能污染你，的一些东西。吐槽：一门语言悲摧到需要反复发明防污染的工具，不知道是先进还是落后啊……（逃……

pipenv 是比较晚发明的应用包管理工具，同时也兼任了环境管理，所以相当于是 pip + virtualenv 的合体，所以它名字也这么暗示了。有篇[知乎](https://zhuanlan.zhihu.com/p/37581807)写得不错。类比 PHP 里的 composer，或者 npm，这个包管理是项目级别的，会在项目目录下生成 Pipfile，Pipfile.lock 文件，用于记录本项目的依赖包。

使用 `pipx install pipenv` 命令来安装 pipenv，然后就可以用 pipenv 来安装各种软件包了。安装 `pipenv install` 可以是项目依赖，或者开发环境的依赖，用 --dev 参数以区分。`pipenv run <command>` 命令可以运行该项目依赖的一些命令。

## black 代码格式化

代码格式化工具 [black](https://github.com/psf/black)，写 Python 也讲究代码格式化的，虽然我觉得 Python 的缩进已经很严格了，不过各种地方要不要加空格之类的，也是一些细小的规矩，这些规矩也都有工具进行控制，也有成文的标准，似乎 PEP8 就是这个标准。

可以使用 `pipenv install black --dev` 来安装，意思是在项目开发的时候，依赖这个包，但是在项目生产环境，应该是不依赖这个包的。使用命令 `pipenv run black .` 来手动运行这个工具，把当前目录下所有 py 文件都给格式化掉。通常，可以结合 `pre-commit` 的钩子来自动触发，这样就确保每次提交的内容，都被正确格式化了。

## isort 引用排序工具

知道这个工具，我又想吐槽，其实又是一个管理污染的辅助工具。这个是一个模块内部范围的污染管理辅助。在一个 py 文件里，我们使用 imports 来引入一些类库，其实就是向这个文件导入一个名字空间，暴露一些符号。我们也可以用 from 语句来导入精确的一个名字，而不是包名字，来提供一些编码上的方便。

一个比较好的实践是将所有的 imports 放在文件的头部，不过写代码的时候并不方便，因为总是要跳动到文件头部。现在这个工具就是，允许程序员在写的时候，随手 imports，随用随导，最后用 isort 自动化工具，一口气把文件中用到的各个 imports 语句，合并，排序移动到文件的顶部，从而得到一个比较统一一致的风格。真是方便！

可以用 `pipenv install isort --dev` 命令来安装，用 `pipenv run isort .` 来对当前目录里的 py 文件执行。

## blake8 静态代码检查工具

## mypy 静态类型检查工具

mypy 是一个可选的静态类型检查工具。

## pytest，pytest-cov 自动化测试工具

## 如何正确配置 Visual Studio Code